<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veo 3.1 Demo (Auth Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }

        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .fade-exit {
            opacity: 1;
            transform: translateY(0);
        }

        .fade-exit-active {
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.5s ease-in, transform 0.5s ease-in;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <nav class="border-b border-gray-700 bg-gray-800 p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                Veo 3.1 Generator
            </h1>
            <div class="w-full md:w-auto flex items-center gap-2">
                <input type="password" id="apiKey" placeholder="è¾“å…¥ Gemini API Key"
                    class="bg-gray-700 text-sm rounded px-3 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 transition border border-gray-600">
                <a href="https://aistudio.google.com/apikey" target="_blank"
                    class="text-xs text-blue-400 hover:text-blue-300 whitespace-nowrap">è·å– Key</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-1 space-y-6">

            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 shadow-lg">
                <label class="block text-sm font-medium text-gray-400 mb-2">ç”Ÿæˆæ¨¡å¼</label>
                <select id="generationMode"
                    class="w-full bg-gray-700 rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none border border-gray-600">
                    <option value="text-to-video">Text to Video (æ–‡ç”Ÿè§†é¢‘)</option>
                    <option value="image-to-video">Image to Video (å›¾ç”Ÿè§†é¢‘)</option>
                    <option value="reference-images">Reference Images (å‚è€ƒå›¾é£æ ¼)</option>
                    <option value="interpolation">Interpolation (é¦–å°¾å¸§æ’å€¼)</option>
                    <option value="extension">Extension (è§†é¢‘æ‰©å±•)</option>
                </select>
                <p id="modeDesc" class="text-xs text-gray-500 mt-2">é€šè¿‡æ–‡æœ¬æç¤ºè¯ç”Ÿæˆè§†é¢‘ã€‚</p>
            </div>

            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 shadow-lg space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">æç¤ºè¯ (Prompt)</label>
                    <textarea id="prompt" rows="4" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘ç”»é¢ã€åŠ¨ä½œå’Œé£æ ¼..."
                        class="w-full bg-gray-700 rounded p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none border border-gray-600 resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">è´Ÿå‘æç¤ºè¯ (Negative Prompt)</label>
                    <input type="text" id="negativePrompt" placeholder="ä¾‹å¦‚: cartoon, blurry, low quality"
                        class="w-full bg-gray-700 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none border border-gray-600">
                </div>
                <div id="dynamicInputs" class="space-y-4"></div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">æ¯”ä¾‹</label>
                        <select id="aspectRatio" class="w-full bg-gray-700 rounded p-2 text-sm border border-gray-600">
                            <option value="16:9">16:9 (æ¨ªå±)</option>
                            <option value="9:16">9:16 (ç«–å±)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">æ—¶é•¿</label>
                        <select id="duration" class="w-full bg-gray-700 rounded p-2 text-sm border border-gray-600">
                            <option value="8">8 ç§’ (æ ‡å‡†)</option>
                        </select>
                    </div>
                </div>
                <button id="generateBtn" onclick="startGeneration()"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    ç”Ÿæˆè§†é¢‘
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col gap-6">
            <div id="resultContainer"
                class="flex-grow bg-gray-800 rounded-xl border border-gray-700 flex items-center justify-center relative overflow-hidden min-h-[400px] shadow-lg">
                <div id="placeholder" class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                    <p>åœ¨å·¦ä¾§é…ç½®å‚æ•°å¹¶ç‚¹å‡»ç”Ÿæˆ</p>
                </div>
                <div id="loadingOverlay"
                    class="absolute inset-0 bg-gray-900/90 z-20 hidden flex flex-col items-center justify-center p-8 text-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-12 w-12 mb-4">
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">æ­£åœ¨ç”Ÿæˆä¸­...</h3>
                    <p class="text-sm text-blue-300 font-mono mb-6" id="statusLog">Status: Starting...</p>
                    <div
                        class="w-full max-w-lg h-24 flex items-center justify-center relative bg-gray-800/50 rounded-lg border border-gray-700 backdrop-blur-sm px-4">
                        <div class="absolute top-2 left-3">
                            <p class="text-[10px] text-yellow-500 uppercase font-bold tracking-wider">ğŸ’¡ Veo ä½¿ç”¨æŠ€å·§</p>
                        </div>
                        <p id="tipText" class="text-sm text-gray-300 leading-relaxed text-center"></p>
                    </div>
                </div>
                <video id="videoPlayer" controls class="hidden w-full h-full object-contain max-h-[600px]"></video>
            </div>
        </div>
    </main>

    <script>
        // --- Constants & Tips ---
        const TIPS = [
            "Veo 3.1 å¯ç”Ÿæˆ 8 ç§’ã€1080p åˆ†è¾¨ç‡ä¸”è‡ªå¸¦åŸç”ŸéŸ³æ•ˆçš„è§†é¢‘ã€‚",
            "å‘æŠ–éŸ³/TikTok é€‰ 9:16 ç«–å±ï¼Œåšç”µå½±çŸ­ç‰‡æˆ– YouTube é€‰ 16:9 å®½å±ã€‚",
            "å¿«é€ŸéªŒè¯åˆ›æ„ç”¨ Fast ç‰ˆæœ¬ï¼Œè¿½æ±‚æœ€ç»ˆé«˜ç”»è´¨ç”¨æ ‡å‡†ç‰ˆã€‚",
            "æ¨¡å‹æ”¯æŒåŸç”ŸéŸ³é¢‘ç”Ÿæˆï¼Œæ— éœ€åæœŸå³å¯è·å¾—èƒŒæ™¯éŸ³ã€éŸ³æ•ˆå’Œå¯¹è¯ã€‚",
            "ä¸‡èƒ½æç¤ºè¯å…¬å¼ï¼šä¸»ä½“ + åŠ¨ä½œ + é£æ ¼ + è¿é•œ + æ°›å›´ã€‚",
            "ç»†èŠ‚å†³å®šæˆè´¥ï¼Œç”¨ä¸°å¯Œçš„å½¢å®¹è¯ï¼ˆå¦‚'ç»æœ›çš„ç”·äºº'ï¼‰ä»£æ›¿ç®€å•çš„åè¯ã€‚",
            "ä½¿ç”¨'è´Ÿé¢æç¤ºè¯'ï¼ˆNegative Promptï¼‰æ’é™¤æ¨¡ç³Šã€æ–‡å­—æˆ–äººç¾¤ç­‰ä¸éœ€è¦çš„å…ƒç´ ã€‚",
            "æŒ‡å®šå…‰å½±æ°›å›´ï¼ˆå¦‚èµ›åšæœ‹å…‹éœ“è™¹ã€é»„é‡‘æ—¶åˆ»ï¼‰èƒ½å¤§å¹…æå‡ç”»é¢è´¨æ„Ÿã€‚",
            "æè¿°ç‰©ä½“æè´¨ï¼ˆå¦‚æ¯›èŒ¸èŒ¸ã€é‡‘å±å…‰æ³½ï¼‰å¯å¢åŠ ç”Ÿæˆç»“æœçš„çœŸå®åº¦ã€‚",
            "åƒå¯¼æ¼”ä¸€æ ·ä½¿ç”¨è¿é•œæœ¯è¯­ï¼šæ¨é•œå¤´(Dolly in)ã€èˆªæ‹(Drone shot)ã€ç¬¬ä¸€è§†è§’(POV)ã€‚",
            "åŠ å…¥'æµ…æ™¯æ·±'æˆ–'è™šåŒ–èƒŒæ™¯'å…³é”®è¯ï¼Œè½»æ¾è·å¾—ç”µå½±çº§é«˜çº§æ„Ÿã€‚",
            "è®¾å®šç‰¹å®šé•œå¤´é£æ ¼ï¼Œå¦‚èƒ¶ç‰‡é¢—ç²’æ„Ÿã€é»‘ç™½ç”µå½±æˆ–æ‰‹æŒæ‘„åƒæœºéœ‡åŠ¨æ„Ÿã€‚",
            "åœ¨æç¤ºè¯ä¸­ä½¿ç”¨åŒå¼•å· \"\" åŒ…è£¹å°è¯ï¼ŒAI å¯ç”Ÿæˆè§’è‰²å¯¹ç™½ã€‚",
            "æ–‡å­—æè¿°å…·ä½“å£°éŸ³ï¼ˆå¦‚'åˆºè€³çš„åˆ¹è½¦å£°'ï¼‰èƒ½å¢å¼ºè§†é¢‘æ²‰æµ¸æ„Ÿã€‚",
            "è®¾å®šç¯å¢ƒéŸ³æ•ˆï¼ˆå¦‚'æ£®æ—é¸Ÿå«'ã€'è¡—é“å˜ˆæ‚'ï¼‰ä»¥å®Œå–„å¬è§‰æ°›å›´ã€‚",
            "å›¾ç”Ÿè§†é¢‘ï¼šä¸Šä¼ ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¬¬ä¸€å¸§ï¼Œè®©é™æ€ç…§ç‰‡åŠ¨èµ·æ¥ã€‚",
            "è§’è‰²ä¸€è‡´æ€§ï¼šä¸Šä¼ å‚è€ƒå›¾å¹¶æ ‡è®°ï¼Œå¯ä¿æŒè§†é¢‘ä¸­äººç‰©é•¿ç›¸ä¸å˜ã€‚",
            "äº§å“å±•ç¤ºï¼šä¸Šä¼ å•†å“å›¾ç‰‡ä½œä¸ºå‚è€ƒï¼Œç¡®ä¿ç”Ÿæˆçš„è§†é¢‘ä¸­äº§å“å¤–è§‚ä¸èµ°æ ·ã€‚",
            "é£æ ¼è¿ç§»ï¼šä¸Šä¼ è‰ºæœ¯ç”»ä½œä½œä¸ºå‚è€ƒå›¾ï¼Œå¯å¤åˆ»ç‰¹å®šçš„è‰ºæœ¯é£æ ¼ã€‚",
            "é¦–å°¾å¸§æ§åˆ¶ï¼šåŒæ—¶ä¸Šä¼ ç¬¬ä¸€å¼ å’Œæœ€åä¸€å¼ å›¾ï¼ŒAI è‡ªåŠ¨è¡¥å…¨ä¸­é—´çš„è¿‡æ¸¡è¿‡ç¨‹ã€‚",
            "è§†é¢‘æ‰©å±•ï¼šå°†ç”Ÿæˆçš„ 8 ç§’è§†é¢‘ä½œä¸ºè¾“å…¥ï¼Œå¯ç»§ç»­ç»­å†™æ—¶é•¿ã€‚",
            "åˆ©ç”¨é®ç½©ï¼ˆMaskï¼‰åŠŸèƒ½å¯é‡ç»˜è§†é¢‘å±€éƒ¨åŒºåŸŸï¼Œç”¨äºå»é™¤ç”»é¢æ‚ç‰©ã€‚",
            "æ‰©å±•è§†é¢‘æ—¶ï¼Œç¡®ä¿æ–°çš„æç¤ºè¯ä¸ä¸Šä¸€æ®µå†…å®¹é€»è¾‘è¿è´¯ï¼Œä¿è¯æ‹¼æ¥è‡ªç„¶ã€‚",
            "ç³»ç»Ÿé™åˆ¶ï¼šä»…æ”¯æŒç”Ÿæˆæˆå¹´äººï¼Œæ— æ³•ç”Ÿæˆå„¿ç«¥æˆ–åäººè‚–åƒã€‚",
            "è®°å½• Seedï¼ˆç§å­æ•°ï¼‰ï¼Œç”¨äºç²¾ç¡®å¤ç°æˆ–å¾®è°ƒåŒä¸€ä¸ªæ»¡æ„çš„è§†é¢‘æ•ˆæœã€‚",
            "å»ºè®®å…ˆç”¨ 720p å¿«é€Ÿæµ‹è¯•åˆ›æ„ï¼Œç¡®è®¤æ»¡æ„åå†ç”Ÿæˆ 1080pã€‚",
            "æç¤ºè¯è¶Šå…·ä½“ï¼ŒAI éšæœºå‘æŒ¥äº§ç”Ÿçš„'å¹»è§‰'å°±è¶Šå°‘ã€‚",
            "ç”Ÿæˆçš„è§†é¢‘è‡ªå¸¦ SynthID éšå½¢æ°´å°ï¼Œç”¨äºæ ‡è¯† AI å†…å®¹ï¼Œè‚‰çœ¼ä¸å¯è§ã€‚",
            "è™½ç„¶æ”¯æŒå¤šè¯­è¨€ï¼Œä½†ä½¿ç”¨è‹±æ–‡ç¼–å†™æç¤ºè¯é€šå¸¸èƒ½è·å¾—æ›´ç²¾å‡†çš„æ•ˆæœã€‚",
            "è§†é¢‘ç”Ÿæˆè®¡ç®—é‡å¤§ï¼Œå¤šå°è¯•å‡ æ¬¡ï¼ˆæŠ½å¡ï¼‰å¾€å¾€èƒ½è·å¾—æƒŠå–œã€‚"
        ];

        // --- State ---
        let currentMode = 'text-to-video';
        let pollInterval = null;
        let tipsInterval = null;
        let currentTipIndex = 0;

        // --- UI Logic ---
        const modeSelect = document.getElementById('generationMode');
        const dynamicInputs = document.getElementById('dynamicInputs');
        const modeDesc = document.getElementById('modeDesc');

        const fileInputTemplate = (id, label, accept = "image/*") => `
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">${label}</label>
                <input type="file" id="${id}" accept="${accept}" 
                    class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-blue-400 hover:file:bg-gray-600 cursor-pointer border border-gray-600 rounded">
            </div>
        `;

        const renderInputs = () => {
            currentMode = modeSelect.value;
            let html = '';
            let desc = '';

            switch (currentMode) {
                case 'text-to-video':
                    desc = "æœ€åŸºç¡€çš„æ¨¡å¼ï¼šä»…é€šè¿‡æ–‡æœ¬æè¿°ç”Ÿæˆè§†é¢‘ã€‚";
                    break;
                case 'image-to-video':
                    desc = "è®©ä¸€å¼ é™æ€å›¾ç‰‡åŠ¨èµ·æ¥ã€‚å›¾ç‰‡å°†ä½œä¸ºè§†é¢‘çš„ç¬¬ä¸€å¸§ã€‚";
                    html += fileInputTemplate('inputImage', 'èµ·å§‹å›¾ç‰‡ (First Frame)');
                    break;
                case 'reference-images':
                    desc = "ä¸Šä¼  1-3 å¼ å‚è€ƒå›¾æ¥æ§åˆ¶è§’è‰²ã€ç‰©ä½“æˆ–é£æ ¼çš„ä¸€è‡´æ€§ã€‚";
                    html += fileInputTemplate('refImg1', 'å‚è€ƒå›¾ 1 (å¿…é¡»)');
                    html += fileInputTemplate('refImg2', 'å‚è€ƒå›¾ 2 (å¯é€‰)');
                    html += fileInputTemplate('refImg3', 'å‚è€ƒå›¾ 3 (å¯é€‰)');
                    break;
                case 'interpolation':
                    desc = "æŒ‡å®šå¼€å§‹å’Œç»“æŸçš„å›¾ç‰‡ï¼ŒAI å°†ç”Ÿæˆä¸­é—´çš„è¿‡æ¸¡åŠ¨ç”»ã€‚";
                    html += fileInputTemplate('inputImage', 'èµ·å§‹å›¾ç‰‡ (Start Frame)');
                    html += fileInputTemplate('lastFrame', 'ç»“æŸå›¾ç‰‡ (End Frame)');
                    break;
                case 'extension':
                    desc = "ä¸Šä¼ ä¸€ä¸ª Veo ç”Ÿæˆçš„è§†é¢‘ï¼Œå¹¶åœ¨å…¶åå»¶ç»­ç”Ÿæˆå†…å®¹ã€‚";
                    html += fileInputTemplate('inputVideo', 'Veo åŸè§†é¢‘ (mp4)', 'video/mp4');
                    break;
            }
            dynamicInputs.innerHTML = html;
            modeDesc.innerText = desc;
        };

        modeSelect.addEventListener('change', renderInputs);
        renderInputs();

        // --- Helper Functions ---
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve({ base64, mimeType: file.type });
                };
                reader.onerror = error => reject(error);
            });
        };

        // --- Tips Logic ---
        const updateTipDisplay = () => {
            const tipEl = document.getElementById('tipText');
            tipEl.classList.remove('fade-enter-active');
            tipEl.classList.add('fade-exit-active');
            setTimeout(() => {
                currentTipIndex = (currentTipIndex + 1) % TIPS.length;
                tipEl.innerText = TIPS[currentTipIndex];
                tipEl.classList.remove('fade-exit-active');
                tipEl.classList.add('fade-enter-active');
            }, 500);
        };

        const startTips = () => {
            if (tipsInterval) clearInterval(tipsInterval);
            const tipEl = document.getElementById('tipText');
            currentTipIndex = Math.floor(Math.random() * TIPS.length);
            tipEl.innerText = TIPS[currentTipIndex];
            tipEl.classList.add('fade-enter-active');
            tipsInterval = setInterval(updateTipDisplay, 8000);
        };

        const stopTips = () => {
            if (tipsInterval) clearInterval(tipsInterval);
            tipsInterval = null;
        };

        const setLoading = (isLoading, statusText = "Starting...") => {
            const overlay = document.getElementById('loadingOverlay');
            const btn = document.getElementById('generateBtn');
            const statusLog = document.getElementById('statusLog');
            statusLog.innerText = `Status: ${statusText}`;

            if (isLoading) {
                overlay.classList.remove('hidden');
                btn.disabled = true;
                btn.innerText = "ç”Ÿæˆä¸­...";
                btn.classList.add('opacity-50');
                startTips();
            } else {
                overlay.classList.add('hidden');
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆè§†é¢‘";
                btn.classList.remove('opacity-50');
                stopTips();
                if (pollInterval) clearInterval(pollInterval);
            }
        };

        // --- API Interaction ---
        async function startGeneration() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) { alert("è¯·å…ˆè¾“å…¥ API Key"); return; }
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) { alert("è¯·è¾“å…¥æç¤ºè¯"); return; }

            setLoading(true, "Preparing payload...");

            // Endpoint (Generative Language API)
            const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/veo-3.1-generate-preview:predictLongRunning";

            let instanceObj = { prompt: prompt };

            let paramsObj = {
                aspectRatio: document.getElementById('aspectRatio').value,
                negativePrompt: document.getElementById('negativePrompt').value,
            };

            const createMediaObj = (data) => ({
                bytesBase64Encoded: data.base64,
                mimeType: data.mimeType
            });

            try {
                // 1. Image to Video
                if (currentMode === 'image-to-video' || currentMode === 'interpolation') {
                    const imgInput = document.getElementById('inputImage');
                    if (imgInput.files.length > 0) {
                        const imgData = await fileToBase64(imgInput.files[0]);
                        instanceObj.image = createMediaObj(imgData);
                    } else { throw new Error("è¯·ä¸Šä¼ èµ·å§‹å›¾ç‰‡"); }
                }

                // 2. Interpolation
                if (currentMode === 'interpolation') {
                    const lastFrameInput = document.getElementById('lastFrame');
                    if (lastFrameInput.files.length > 0) {
                        const imgData = await fileToBase64(lastFrameInput.files[0]);
                        instanceObj.lastFrame = createMediaObj(imgData);
                    } else { throw new Error("æ’å€¼æ¨¡å¼éœ€è¦ä¸Šä¼ ç»“æŸå›¾ç‰‡"); }
                }

                // 3. Reference Images
                if (currentMode === 'reference-images') {
                    const refs = [];
                    for (let i = 1; i <= 3; i++) {
                        const el = document.getElementById(`refImg${i}`);
                        if (el && el.files.length > 0) {
                            const data = await fileToBase64(el.files[0]);
                            refs.push({
                                image: createMediaObj(data),
                                referenceType: "asset"
                            });
                        }
                    }
                    if (refs.length === 0) throw new Error("è‡³å°‘éœ€è¦ä¸Šä¼ ä¸€å¼ å‚è€ƒå›¾");
                    instanceObj.referenceImages = refs;
                }

                // 4. Extension
                if (currentMode === 'extension') {
                    const vidInput = document.getElementById('inputVideo');
                    if (vidInput.files.length > 0) {
                        const vidData = await fileToBase64(vidInput.files[0]);
                        instanceObj.video = createMediaObj(vidData);
                    } else { throw new Error("æ‰©å±•æ¨¡å¼éœ€è¦ä¸Šä¼ åŸè§†é¢‘"); }
                }

                const payload = {
                    instances: [instanceObj],
                    parameters: paramsObj
                };

                console.log("Payload:", payload);

                setLoading(true, "Sending request...");

                const response = await fetch(`${BASE_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Failed to start generation");
                }

                const data = await response.json();
                const operationName = data.name;
                console.log("Operation started:", operationName);
                pollOperation(operationName, apiKey);

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                setLoading(false);
            }
        }

        async function pollOperation(operationName, apiKey) {
            const pollUrl = `https://generativelanguage.googleapis.com/v1beta/${operationName}?key=${apiKey}`;

            pollInterval = setInterval(async () => {
                try {
                    const statusLog = document.getElementById('statusLog');
                    statusLog.innerText = "Status: Rendering video...";

                    const res = await fetch(pollUrl);
                    const opData = await res.json();

                    if (opData.error) throw new Error(opData.error.message);

                    if (opData.done) {
                        clearInterval(pollInterval);
                        handleSuccess(opData);
                    }
                } catch (e) {
                    clearInterval(pollInterval);
                    alert("Polling Error: " + e.message);
                    setLoading(false);
                }
            }, 5000);
        }

        // --- Optimized Success Handler with 403 Fix ---
        function handleSuccess(data) {
            const statusLog = document.getElementById('statusLog');
            statusLog.innerText = "Status: æ­£åœ¨åŠ è½½è§†é¢‘æ•°æ® (Downloading)...";

            const tipText = document.getElementById('tipText');
            tipText.innerText = "ç”ŸæˆæˆåŠŸï¼æ­£åœ¨ç¼“å†²è§†é¢‘æµï¼Œè¯·ç¨å€™...";

            const samples = data.response?.generateVideoResponse?.generatedSamples;

            if (!samples || samples.length === 0) {
                setLoading(false);
                alert("ç”Ÿæˆå®Œæˆï¼Œä½†æ²¡æœ‰æ‰¾åˆ°è§†é¢‘æ•°æ®ã€‚");
                return;
            }

            const videoInfo = samples[0].video;
            const videoUri = videoInfo.uri;
            const player = document.getElementById('videoPlayer');

            if (videoUri) {
                // --- Fix 403 Error: Append API Key to fetch URL ---
                const apiKey = document.getElementById('apiKey').value.trim();
                // æ™ºèƒ½åˆ¤æ–­ URL æ˜¯å¦å·²æœ‰å‚æ•°ï¼Œæ­£ç¡®æ‹¼æ¥ key
                const fetchUrl = `${videoUri}${videoUri.includes('?') ? '&' : '?'}key=${apiKey}`;

                fetch(fetchUrl)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP Error: ${r.status}`);
                        return r.blob();
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);

                        document.getElementById('placeholder').classList.add('hidden');
                        player.classList.remove('hidden');

                        player.src = url;

                        player.onloadeddata = () => {
                            setLoading(false);
                            player.play().catch(e => console.log("Autoplay blocked", e));
                        };

                        setTimeout(() => setLoading(false), 1000);
                    })
                    .catch((err) => {
                        console.error("è§†é¢‘æµåŠ è½½å¤±è´¥", err);
                        // Fallback: å¦‚æœ fetch å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨å¸¦ key çš„é“¾æ¥
                        player.src = fetchUrl;
                        player.classList.remove('hidden');
                        setLoading(false);
                    });
            } else {
                setLoading(false);
                alert("æœªè·å–åˆ°è§†é¢‘ URI");
            }
        }
    </script>
</body>

</html>